<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>📖 Quran Explorer - Shoib&#x27;s Space</title><meta name="description" content="The digital home of Shoib’s thoughts, projects, and passions."><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://www.shoib.me/quran-explorer/"><link rel="alternate" type="application/atom+xml" href="https://www.shoib.me/feed.xml" title="Shoib&#x27;s Space - RSS"><link rel="alternate" type="application/json" href="https://www.shoib.me/feed.json" title="Shoib&#x27;s Space - JSON"><meta property="og:title" content="📖 Quran Explorer"><meta property="og:image" content="https://www.shoib.me/media/website/icons8-swot-analysis-400.png"><meta property="og:image:width" content="400"><meta property="og:image:height" content="400"><meta property="og:site_name" content="Shoib's Space"><meta property="og:description" content="The digital home of Shoib’s thoughts, projects, and passions."><meta property="og:url" content="https://www.shoib.me/quran-explorer/"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://www.shoib.me/media/website/icons8-swot-analysis-50-3.png" type="image/png"><link rel="preload" href="https://www.shoib.me/assets/dynamic/fonts/jetbrainsmono/jetbrainsmono.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="https://www.shoib.me/assets/dynamic/fonts/jetbrainsmono/jetbrainsmono-italic.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://www.shoib.me/assets/css/style.css?v=2e46e1f2fc98a3dc054c47a693e5312f"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.shoib.me/quran-explorer/"},"headline":"📖 Quran Explorer","datePublished":"2025-05-27T22:15+05:00","dateModified":"2025-06-01T22:43+05:00","image":{"@type":"ImageObject","url":"https://www.shoib.me/media/website/icons8-swot-analysis-400.png","height":400,"width":400},"description":"The digital home of Shoib’s thoughts, projects, and passions.","author":{"@type":"Person","name":"Muhammad Shoib","url":"https://www.shoib.me/authors/muhammad-shoib/"},"publisher":{"@type":"Organization","name":"Muhammad Shoib","logo":{"@type":"ImageObject","url":"https://www.shoib.me/media/website/icons8-swot-analysis-400.png","height":400,"width":400}}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript><style>.extlink::after {
				background-color: currentColor;
				content: "";
				display: inline-block;
				height: 16px;
				margin-left: 5px;
				position: relative;
				top: 0px;
				width: 16px;
			}
		
					.extlink.extlink-icon-1::after {
						mask-image: url("data:image/svg+xml;utf8,<svg viewBox='0 0 24 24' fill='none' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' xmlns='http://www.w3.org/2000/svg'><path d='M15 3h6v6'/><path d='M10 14 21 3'/><path d='M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6'/></svg>");
						mask-repeat: no-repeat;
						mask-size: contain;
					}</style><style>.fi{fill:none;stroke-linecap:round;stroke-linejoin:round;vertical-align:middle}</style></head><body class="page-template"><div class="container container--center"><header class="header"><div class="header__logo"><a class="logo" href="https://www.shoib.me/"><img src="https://www.shoib.me/media/website/icons8-swot-analysis-400.png" alt="Shoib&#x27;s Space" width="400" height="400"></a></div><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://www.shoib.me/blog-and-insights/" target="_self">Blog</a></li><li><a href="https://www.shoib.me/services-and-solutions/" target="_self">Services &amp; Solutions</a></li><li><a href="https://www.shoib.me/projects-and-case-studies/" target="_self">Projects &amp; Case Studies</a></li><li><span class="is-separator">Pages</span></li><li><a href="https://www.shoib.me/advanced-lunar-month-calculator/" target="_self">Advanced Lunar Month Calculator</a></li><li class="active"><a href="https://www.shoib.me/quran-explorer/" target="_self">📖 Quran Explorer</a></li></ul></nav></header><main class="content page"><article class="post"><header><h1 class="post__title">📖 Quran Explorer</h1></header><div class="post__entry"><div class="container"><h2>📖 Quran Explorer</h2><div class="controls-grid"><div class="input-group"><label for="surah">📜 Select Surah:</label><select id="surah"></select></div><div class="input-group"><label for="ayah">🔢 Select Ayah:</label><select id="ayah"></select></div><div class="input-group"><label for="translation-select">🇹🇷 Translation:</label><select id="translation-select"></select></div><div class="input-group"><label for="reciter-select">🔊 Select Reciter:</label><select id="reciter-select"></select></div></div><div class="action-buttons"><button id="show-ayah-btn">📖 Show Ayah</button> <button id="show-full-surah-btn">📜 Show Full Surah</button></div><hr class="separator"><div class="keyword-search-group"><div class="input-group"><label for="keyword-input">🔍 Search Keyword:</label> <input id="keyword-input" type="text" placeholder="e.g., Mercy, رحمن"></div><button id="search-keyword-btn">Search</button></div><div id="quran-container" style="margin-top: 30px;"><p class="message">Welcome! Please select a Surah to begin.</p></div><audio loading="lazy" style="display: none;" id="ayah-audio-player"></audio></div><p><script>const surahSelect = document.getElementById("surah");
    const ayahSelect = document.getElementById("ayah");
    const translationSelect = document.getElementById("translation-select");
    const reciterSelect = document.getElementById("reciter-select");
    const quranContainer = document.getElementById("quran-container");
    const showAyahButton = document.getElementById("show-ayah-btn");
    const showFullSurahButton = document.getElementById("show-full-surah-btn");
    const keywordInput = document.getElementById("keyword-input");
    const searchKeywordButton = document.getElementById("search-keyword-btn");
    const audioPlayer = document.getElementById("ayah-audio-player");

    const API_BASE_URL = "https://api.alquran.cloud/v1";
    let currentDisplayMode = 'none'; // 'none', 'surah', or 'ayah'
    let currentAudioURL = null;
    let currentPlayAyahButton = null;
    let editionsCache = null; // To store edition details

    const LS_KEYS = {
        SURAH: 'quranExplorer_lastSurah_v2', 
        AYAH: 'quranExplorer_lastAyah_v2',
        TRANSLATION: 'quranExplorer_lastTranslation_v2',
        RECITER: 'quranExplorer_lastReciter_v2',
        DISPLAY_MODE: 'quranExplorer_lastDisplayMode_v2'
    };

    // Language display mapping
    const languageDisplayMap = {
        en: 'English', ar: 'Arabic (العربية)', ur: 'Urdu (اردو)', es: 'Spanish (Español)',
        fr: 'French (Français)', de: 'German (Deutsch)', id: 'Indonesian (Bahasa Indonesia)',
        tr: 'Turkish (Türkçe)', ru: 'Russian (Русский)', bn: 'Bengali (বাংলা)',
        hi: 'Hindi (हिन्दी)', fa: 'Persian (فارسی)', sq: 'Albanian (Shqip)',
        az: 'Azerbaijani (Azərbaycanca)', bs: 'Bosnian (Bosanski)',
        bg: 'Bulgarian (Български)', zh: 'Chinese (中文)', cs: 'Czech (Čeština)',
        dv: 'Divehi (ދިވެހިބަސް)', ha: 'Hausa', it: 'Italian (Italiano)',
        ja: 'Japanese (日本語)', ko: 'Korean (한국어)', ku: 'Kurdish (Kurdî)',
        ml: 'Malayalam (മലയാളം)', ms: 'Malay (Bahasa Melayu)', nl: 'Dutch (Nederlands)',
        no: 'Norwegian (Norsk)', pl: 'Polish (Polski)', pt: 'Portuguese (Português)',
        ro: 'Romanian (Română)', sd: 'Sindhi (سنڌي)', so: 'Somali (Soomaali)',
        sv: 'Swedish (Svenska)', sw: 'Swahili (Kiswahili)', ta: 'Tamil (தமிழ்)',
        tg: 'Tajik (Тоҷикӣ)', th: 'Thai (ไทย)', tt: 'Tatar (Татар)', ug: 'Uyghur (ئۇيغۇرچە)',
        uz: 'Uzbek (Oʻzbekcha)'
        // Add more comprehensive list as needed
    };

    function getLanguageDisplayName(langCode) {
        return languageDisplayMap[langCode.toLowerCase()] || langCode.toUpperCase();
    }


    function setControlsDisabled(disabled) {
        [surahSelect, ayahSelect, translationSelect, reciterSelect, showAyahButton, showFullSurahButton, keywordInput, searchKeywordButton].forEach(el => {
            if (el) el.disabled = disabled;
        });
    }

    function showLoadingMessage(message) {
        quranContainer.innerHTML = `<p class="message">${message}</p>`;
    }

    function showErrorMessage(message) {
        quranContainer.innerHTML = `<p class="message error-message">Error: ${message}</p>`;
    }

    async function fetchData(url, errorMessagePrefix = "API Call") {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                let errorData = {};
                try {
                    errorData = await response.json();
                } catch (e) { /* Ignore if error response is not JSON */ }
                console.error(`${errorMessagePrefix} Error: ${response.status} ${response.statusText}`, errorData);
                throw new Error(`${errorMessagePrefix} failed: ${errorData.data || errorData.error || response.statusText || 'Unknown error'}`);
            }
            return response.json();
        } catch (error) {
            console.error(`Network or other error during ${errorMessagePrefix}:`, error);
            throw error; 
        }
    }
    
    async function fetchAllEditions() {
        if (editionsCache) return editionsCache;
        try {
            const data = await fetchData(`${API_BASE_URL}/edition`, 'Fetching all editions');
            editionsCache = data.data;
            return editionsCache;
        } catch (error) {
            console.error("Could not fetch editions list:", error);
            showErrorMessage("Failed to load essential edition data. Please refresh.");
            return []; 
        }
    }

    // Generic populator for Reciter (flat lists), used by populateReciterSelect
    async function populateGenericSelectWithOptions(selectElement, filterCallback, optionValueField, optionTextField, defaultText, namePropertyForText) {
        selectElement.disabled = true;
        selectElement.innerHTML = `<option value="">Loading ${defaultText}...</option>`;
        try {
            const allEditions = await fetchAllEditions();
            const filteredEditions = allEditions.filter(filterCallback);
            
            selectElement.innerHTML = `<option value="">--- Select ${defaultText} ---</option>`;
            if (filteredEditions.length > 0) {
                // Sort reciters alphabetically by their display name
                filteredEditions.sort((a,b) => {
                    const nameA = a[namePropertyForText] || a[optionTextField] || a[optionValueField];
                    const nameB = b[namePropertyForText] || b[optionTextField] || b[optionValueField];
                    return nameA.localeCompare(nameB);
                });

                filteredEditions.forEach(item => {
                    const option = document.createElement("option");
                    option.value = item[optionValueField];
                    option.textContent = item[namePropertyForText] || item[optionTextField] || item[optionValueField];
                    if (item.language) {
                        option.textContent += ` (${item.language.toUpperCase()})`;
                    }
                    selectElement.appendChild(option);
                });
            } else {
                selectElement.innerHTML = `<option value="">No ${defaultText} Found</option>`;
            }
        } catch (error) {
            console.error(`Error populating ${defaultText}:`, error);
            selectElement.innerHTML = `<option value="">Error loading ${defaultText}</option>`;
        } finally {
            selectElement.disabled = false;
        }
    }
    
    async function populateAyahDropdownForSurah(surahNumber) {
        ayahSelect.disabled = true;
        ayahSelect.innerHTML = '<option value="">Loading Ayahs...</option>';
        try {
            const data = await fetchData(`${API_BASE_URL}/surah/${surahNumber}`, `Fetching Ayahs for Surah ${surahNumber}`);
            ayahSelect.innerHTML = `<option value="">--- Select Ayah ---</option>`;
            if (data.data && data.data.numberOfAyahs) {
                for (let i = 1; i <= data.data.numberOfAyahs; i++) {
                    const option = document.createElement("option");
                    option.value = i;
                    option.textContent = `Ayah ${i}`;
                    ayahSelect.appendChild(option);
                }
            } else {
                ayahSelect.innerHTML = '<option value="">No Ayahs found</option>';
            }
        } catch (error) {
            console.error(`Error loading Ayahs for Surah ${surahNumber}:`, error);
            ayahSelect.innerHTML = `<option value="">Error loading Ayahs</option>`;
        } finally {
            ayahSelect.disabled = false;
        }
    }

    async function populateTranslationSelect() {
        translationSelect.disabled = true;
        translationSelect.innerHTML = '<option value="">Loading Translations...</option>';
        try {
            const allEditions = await fetchAllEditions();
            const textTranslations = allEditions.filter(e => e.format === 'text' && e.type === 'translation');

            const groupedByLanguage = {};
            textTranslations.forEach(edition => {
                const lang = edition.language;
                if (!groupedByLanguage[lang]) {
                    groupedByLanguage[lang] = [];
                }
                groupedByLanguage[lang].push(edition);
            });

            translationSelect.innerHTML = ''; 

            const sortedLanguageCodes = Object.keys(groupedByLanguage).sort((a, b) => {
                if (a === 'en') return -1; if (b === 'en') return 1;
                if (a === 'ar') return -1; if (b === 'ar') return 1;
                return getLanguageDisplayName(a).localeCompare(getLanguageDisplayName(b));
            });

            if (sortedLanguageCodes.length === 0) {
                 translationSelect.innerHTML = '<option value="">No Translations Found</option>';
            } else {
                const placeholderOption = document.createElement("option");
                placeholderOption.value = "";
                placeholderOption.textContent = "--- Select Translation ---";
                translationSelect.appendChild(placeholderOption);

                sortedLanguageCodes.forEach(langCode => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = getLanguageDisplayName(langCode);
                    
                    groupedByLanguage[langCode].sort((a,b) => {
                        const nameA = a.name || a.identifier; 
                        const nameB = b.name || b.identifier;
                        return nameA.localeCompare(nameB);
                    }).forEach(edition => {
                        const option = document.createElement('option');
                        option.value = edition.identifier;
                        
                        let translationSpecificName = edition.name; 
                        // If 'name' is too long (e.g., >30 chars) or empty, use the identifier for brevity
                        if (!translationSpecificName || translationSpecificName.length > 30) { 
                            translationSpecificName = edition.identifier;
                        }
                        // Prepend language code for easier keyboard navigation
                        const langCodePrefix = edition.language ? edition.language.toUpperCase() : '??'; 
                        option.textContent = `${langCodePrefix}: ${translationSpecificName}`; 
                        optgroup.appendChild(option);
                    });
                    translationSelect.appendChild(optgroup);
                });
            }
            
            const defaultTranslationId = localStorage.getItem(LS_KEYS.TRANSLATION) || 'en.sahih';
            if (Array.from(translationSelect.options).some(opt => opt.value === defaultTranslationId)) {
                translationSelect.value = defaultTranslationId;
            } else if (translationSelect.querySelector('optgroup option')) { 
                 translationSelect.value = translationSelect.querySelector('optgroup option').value;
            }


        } catch (error) {
            console.error("Error populating translations:", error);
            translationSelect.innerHTML = `<option value="">Error loading Translations</option>`;
        } finally {
            translationSelect.disabled = false;
        }
    }

    async function populateReciterSelect() {
        await populateGenericSelectWithOptions(reciterSelect,
            (e) => e.format === 'audio' && e.type === 'versebyverse', 
            'identifier', 'name', 'Reciter', 'englishName');

        const defaultReciterId = localStorage.getItem(LS_KEYS.RECITER) || 'ar.alafasy';
         if (Array.from(reciterSelect.options).some(opt => opt.value === defaultReciterId)) {
            reciterSelect.value = defaultReciterId;
        } else if (reciterSelect.options.length > 1 && reciterSelect.options[1]) { 
            reciterSelect.value = reciterSelect.options[1].value;
        }
    }


    function saveToLocalStorage() {
        if (surahSelect.value) localStorage.setItem(LS_KEYS.SURAH, surahSelect.value); else localStorage.removeItem(LS_KEYS.SURAH);
        if (translationSelect.value) localStorage.setItem(LS_KEYS.TRANSLATION, translationSelect.value); else localStorage.removeItem(LS_KEYS.TRANSLATION);
        if (reciterSelect.value) localStorage.setItem(LS_KEYS.RECITER, reciterSelect.value); else localStorage.removeItem(LS_KEYS.RECITER);
        
        localStorage.setItem(LS_KEYS.DISPLAY_MODE, currentDisplayMode);
        if (currentDisplayMode === 'ayah' && ayahSelect.value) {
            localStorage.setItem(LS_KEYS.AYAH, ayahSelect.value);
        } else {
            localStorage.removeItem(LS_KEYS.AYAH);
        }
    }
    
    function createPlayButton(audioSrc, ayahRef) {
        const button = document.createElement('button');
        button.textContent = '▶️ Play Audio';
        button.className = 'play-audio-btn'; 
        if (!audioSrc) {
            button.disabled = true;
            button.textContent = 'Audio N/A';
        } else {
            button.onclick = () => playAyahAudio(audioSrc, button, ayahRef);
        }
        return button;
    }

    function playAyahAudio(audioSrc, button, ayahRef) {
        if (audioPlayer.src === audioSrc && !audioPlayer.paused) {
            audioPlayer.pause();
        } else {
            if(currentPlayAyahButton && currentPlayAyahButton !== button) {
                currentPlayAyahButton.textContent = '▶️ Play Audio';
            }
            audioPlayer.src = audioSrc;
            currentAudioURL = audioSrc; 
            audioPlayer.play().then(() => {
                button.textContent = 'Playing... 🎵';
                currentPlayAyahButton = button; 
            }).catch(err => {
                console.error("Error playing audio:", err);
                button.textContent = '▶️ Play Audio'; 
                currentPlayAyahButton = null;
                alert(`Could not play audio for ${ayahRef}. ${err.message}`);
            });
        }
    }

    audioPlayer.onended = () => {
        if(currentPlayAyahButton) {
            currentPlayAyahButton.textContent = '▶️ Play Audio';
            currentPlayAyahButton = null;
        }
        currentAudioURL = null;
    };

    audioPlayer.onpause = () => {
        if(currentPlayAyahButton && audioPlayer.src === currentAudioURL && audioPlayer.paused) {
            currentPlayAyahButton.textContent = '▶️ Play Audio';
        }
    };


    async function displaySingleAyah(isRestoring = false) {
        const surahNumber = surahSelect.value;
        const ayahNumberInSurah = ayahSelect.value;
        const selectedTranslationId = translationSelect.value;
        const selectedReciterId = reciterSelect.value;

        if (!surahNumber || !ayahNumberInSurah || !selectedTranslationId || !selectedReciterId) {
            if(!isRestoring) showErrorMessage("Please select Surah, Ayah, Translation, and Reciter to display an Ayah.");
            return;
        }

        setControlsDisabled(true);
        showLoadingMessage(`Loading Ayah ${surahNumber}:${ayahNumberInSurah}...`);
        currentDisplayMode = 'ayah';
        
        try {
            const editionsToFetch = `quran-uthmani,${selectedTranslationId},${selectedReciterId}`;
            const data = await fetchData(`${API_BASE_URL}/ayah/${surahNumber}:${ayahNumberInSurah}/editions/${editionsToFetch}`, `Ayah ${surahNumber}:${ayahNumberInSurah}`);
            
            const arabicAyah = data.data.find(a => a.edition.identifier === 'quran-uthmani');
            const translatedAyah = data.data.find(a => a.edition.identifier === selectedTranslationId);
            const audioAyahData = data.data.find(a => a.edition.identifier === selectedReciterId);

            if (!arabicAyah) throw new Error("Arabic text for the Ayah was not found in the API response.");
            
            const audioSrcForButton = audioAyahData ? audioAyahData.audio : null;
            const ayahRefForAudio = `Ayah ${surahNumber}:${ayahNumberInSurah}`;
            const playButton = createPlayButton(audioSrcForButton, ayahRefForAudio);

            quranContainer.innerHTML = `
                <div class="surah-title">
                    <h3>${arabicAyah.surah.name} (${arabicAyah.surah.englishName})</h3>
                    <p>${arabicAyah.surah.englishNameTranslation}</p>
                </div>
                <div class="ayah">
                    <div class="ayah-header">
                        <p class="ayah-number">الآية ${arabicAyah.numberInSurah} (Ayah ${arabicAyah.numberInSurah})</p>
                        <div id="play-button-container"></div>
                    </div>
                    <p class="arabic-text">${arabicAyah.text}</p>
                    ${translatedAyah ? `
                        <p class="translation-text">${translatedAyah.text}</p>
                        <p class="translation-credit">(Translation: ${translatedAyah.edition.englishName || translatedAyah.edition.name})</p>
                    ` : `<p class="translation-text error-message" style="font-size:0.95em; padding:8px; text-align:left;">Selected translation not available for this Ayah.</p>`}
                </div>`;
            const playButtonContainer = document.getElementById('play-button-container');
            if (playButtonContainer) playButtonContainer.appendChild(playButton);
            
            saveToLocalStorage();
        } catch (error) {
            console.error("Error fetching Ayah:", error);
            showErrorMessage(error.message || "Failed to fetch the Ayah. The selected editions might not be available.");
            currentDisplayMode = 'none'; 
        } finally {
            setControlsDisabled(false);
        }
    }

    async function displayFullSurah(isRestoring = false) {
        const surahNumber = surahSelect.value;
        const selectedTranslationId = translationSelect.value;

        if (!surahNumber || !selectedTranslationId) {
            if(!isRestoring) showErrorMessage("Please select a Surah and a Translation to display the full Surah.");
            return;
        }

        setControlsDisabled(true);
        showLoadingMessage(`Loading Surah ${surahNumber} with selected translation...`);
        currentDisplayMode = 'surah';
        
        try {
            const editionsToFetch = `quran-uthmani,${selectedTranslationId}`;
            const data = await fetchData(`${API_BASE_URL}/surah/${surahNumber}/editions/${editionsToFetch}`, `Full Surah ${surahNumber}`);

            const arabicSurah = data.data.find(s => s.edition.identifier === 'quran-uthmani');
            const translatedSurah = data.data.find(s => s.edition.identifier === selectedTranslationId);

            if (!arabicSurah) throw new Error("Arabic text for the Surah was not found in the API response.");

            let ayahsHtml = arabicSurah.ayahs.map((ayah, index) => {
                const translationText = translatedSurah && translatedSurah.ayahs[index] ? translatedSurah.ayahs[index].text : "Selected translation not available for this Ayah.";
                const translationAvailable = translatedSurah && translatedSurah.ayahs[index];
                return `
                    <div class="ayah">
                        <p class="ayah-number">الآية ${ayah.numberInSurah} (Ayah ${ayah.numberInSurah})</p>
                        <p class="arabic-text">${ayah.text}</p>
                        <p class="translation-text ${!translationAvailable ? 'error-message' : ''}" style="${!translationAvailable ? 'font-size:0.95em; padding:8px; text-align:left;' : ''}">${translationText}</p>
                    </div>`;
            }).join('');

            quranContainer.innerHTML = `
                <div class="surah-title">
                    <h3>${arabicSurah.name} (${arabicSurah.englishName})</h3>
                    <p><em>${arabicSurah.englishNameTranslation}</em></p>
                    <p>Number of Ayahs: ${arabicSurah.numberOfAyahs} | Revelation Type: ${arabicSurah.revelationType}</p>
                    ${translatedSurah ? `<p class="translation-credit" style="text-align:left;">(Displaying Translation: ${translatedSurah.edition.englishName || translatedSurah.edition.name})</p>` : ''}
                </div>
                ${ayahsHtml}`;
            saveToLocalStorage();
        } catch (error) {
            console.error("Error fetching full Surah:", error);
            showErrorMessage(error.message || "Failed to fetch the full Surah. The selected translation might not be available.");
            currentDisplayMode = 'none';
        } finally {
            setControlsDisabled(false);
        }
    }
    
    async function handleSurahChange() {
        setControlsDisabled(true);
        const surahNumber = surahSelect.value;
        if (surahNumber) {
            quranContainer.innerHTML = ''; 
            showLoadingMessage(`Loading Surah ${surahNumber} details...`);
            await populateAyahDropdownForSurah(surahNumber);
            await displayFullSurah(); 
        } else {
            quranContainer.innerHTML = '<p class="message">Please select a Surah to display.</p>';
            ayahSelect.innerHTML = '<option value="">Select Ayah</option>';
            currentDisplayMode = 'none';
            localStorage.removeItem(LS_KEYS.SURAH);
            localStorage.removeItem(LS_KEYS.AYAH);
            setControlsDisabled(false);
        }
    }

    async function handleSettingsChange() { 
        if (currentDisplayMode === 'none' && !surahSelect.value) {
             const selectedTranslationInfo = translationSelect.options[translationSelect.selectedIndex]?.text || "selected translation";
             const selectedReciterInfo = reciterSelect.options[reciterSelect.selectedIndex]?.text || "selected reciter";
             quranContainer.innerHTML = `<p class="message">Translation: ${selectedTranslationInfo}.<br>Reciter: ${selectedReciterInfo}.<br>Please select a Surah.</p>`;
             saveToLocalStorage();
             return;
        }

        if (currentDisplayMode === 'ayah' && surahSelect.value && ayahSelect.value) {
            await displaySingleAyah();
        } else if ((currentDisplayMode === 'surah' || currentDisplayMode === 'none') && surahSelect.value) { 
            await displayFullSurah();
        }
    }
    
    async function initializeQuranExplorer() {
        setControlsDisabled(true);
        showLoadingMessage("Initializing Quran Explorer...");
        
        await fetchAllEditions(); 
        
        try {
            const surahData = await fetchData(`${API_BASE_URL}/surah`, "Fetching Surah List");
            surahSelect.innerHTML = `<option value="">--- Select Surah ---</option>`;
            if (surahData.data && surahData.data.length > 0) {
                surahData.data.forEach(item => {
                    const option = document.createElement("option");
                    option.value = item.number;
                    option.textContent = `${item.number}. ${item.englishName} (${item.name})`;
                    surahSelect.appendChild(option);
                });
            } else {
                 surahSelect.innerHTML = `<option value="">No Surahs Found</option>`;
            }
        } catch (e) {
            console.error("Error initializing Surah list:", e);
            surahSelect.innerHTML = `<option value="">Error Loading Surahs</option>`;
        }

        await populateTranslationSelect();
        await populateReciterSelect();

        const lastSurah = localStorage.getItem(LS_KEYS.SURAH);
        const lastAyah = localStorage.getItem(LS_KEYS.AYAH);
        const lastDisplayMode = localStorage.getItem(LS_KEYS.DISPLAY_MODE);
        let restored = false;

        if (lastSurah && Array.from(surahSelect.options).some(opt => opt.value === lastSurah)) {
            surahSelect.value = lastSurah;
            await populateAyahDropdownForSurah(lastSurah);
            
            if (lastDisplayMode === 'ayah' && lastAyah && Array.from(ayahSelect.options).some(opt => opt.value === lastAyah)) {
                ayahSelect.value = lastAyah;
                await displaySingleAyah(true);
                restored = true;
            } else if (lastDisplayMode === 'surah' || !lastDisplayMode || lastDisplayMode === 'none') { 
                await displayFullSurah(true);
                restored = true;
            }
        }

        if (!restored) {
            quranContainer.innerHTML = `<p class="message">Welcome! Please select a Surah to begin.</p>`;
            currentDisplayMode = 'none';
        }
        setControlsDisabled(false);
    }

    async function searchByKeyword() {
        const keyword = keywordInput.value.trim();
        if (!keyword) {
            showErrorMessage("Please enter a keyword to search.");
            return;
        }
        setControlsDisabled(true);
        showLoadingMessage(`Searching for "${keyword}"...`);
        quranContainer.innerHTML = ''; 
        currentDisplayMode = 'search';

        const defaultEnglishEdition = 'en.sahih';
        const arabicEdition = 'quran-uthmani';
        const selectedTranslationEditionId = translationSelect.value;

        let editionsToSearchDetails = [];
        editionsToSearchDetails.push({ id: arabicEdition, name: 'Uthmani Script (Arabic)', lang: 'ar', dir: 'rtl' });
        editionsToSearchDetails.push({ id: defaultEnglishEdition, name: 'Sahih International (English)', lang: 'en', dir: 'ltr' });
        
        if (selectedTranslationEditionId && selectedTranslationEditionId !== defaultEnglishEdition && selectedTranslationEditionId !== arabicEdition) {
            const selectedEditionInfo = editionsCache ? editionsCache.find(e => e.identifier === selectedTranslationEditionId) : null;
            if (selectedEditionInfo && selectedEditionInfo.format === 'text') {
                 editionsToSearchDetails.push({ 
                    id: selectedTranslationEditionId, 
                    name: selectedEditionInfo.englishName || selectedEditionInfo.name, 
                    lang: selectedEditionInfo.language, 
                    dir: ['ar', 'ur', 'fa', 'dv', 'sd', 'ug'].includes(selectedEditionInfo.language) ? 'rtl' : 'ltr'
                });
            }
        }
        editionsToSearchDetails = editionsToSearchDetails.filter((edition, index, self) =>
            index === self.findIndex((e) => e.id === edition.id)
        );

        let allMatches = [];
        try {
            for (const edition of editionsToSearchDetails) {
                try {
                    const data = await fetchData(`${API_BASE_URL}/search/${encodeURIComponent(keyword)}/all/${edition.id}`, `Searching in ${edition.name}`);
                    if (data.code === 200 && data.data && data.data.matches && data.data.matches.length > 0) {
                        allMatches.push(...data.data.matches.map(match => ({...match, searchedEditionName: edition.name, searchedEditionLang: edition.lang, searchedEditionDir: edition.dir})));
                    }
                } catch (searchError) {
                    console.warn(`Could not search in ${edition.name}: ${searchError.message}`);
                }
            }

            if (allMatches.length === 0) {
                quranContainer.innerHTML = `<p class="message">No results found for "${keyword}" in the searched editions.</p>`;
            } else {
                const uniqueMatches = [];
                const seenAyahs = new Set();
                for (const match of allMatches) {
                    const ayahKey = `${match.surah.number}:${match.numberInSurah}`;
                    if (!seenAyahs.has(ayahKey)) {
                        uniqueMatches.push(match);
                        seenAyahs.add(ayahKey);
                    }
                }
                uniqueMatches.sort((a, b) => (a.surah.number - b.surah.number) || (a.numberInSurah - b.numberInSurah));

                let resultsHtml = `<h2 style="margin-bottom:20px; text-align:left; font-size:1.6em;">Search Results for "${keyword}" (${uniqueMatches.length} unique Ayahs found):</h2>`;
                resultsHtml += uniqueMatches.map(match => `
                    <div class="search-result-item" data-surah-number="${match.surah.number}" data-ayah-number="${match.numberInSurah}">
                        <p class="surah-info">
                            Surah ${match.surah.number}: ${match.surah.englishName} (${match.surah.name}) - Ayah ${match.numberInSurah}
                        </p>
                        <div class="matched-text-edition">
                            <p><em>Matched in ${match.searchedEditionName} (click to view Ayah):</em></p>
                            <p class="ayah-text-search" lang="${match.searchedEditionLang}" dir="${match.searchedEditionDir}">${match.text}</p>
                        </div>
                    </div>`).join('');
                quranContainer.innerHTML = resultsHtml;
            }
        } catch (error) { 
            console.error("Error during keyword search process:", error);
            showErrorMessage(error.message || "Keyword search failed due to an unexpected issue.");
        } finally {
            setControlsDisabled(false);
        }
    }

    quranContainer.addEventListener('click', async (event) => {
        const searchItem = event.target.closest('.search-result-item');
        if (searchItem) {
            const surahNum = searchItem.dataset.surahNumber;
            const ayahNum = searchItem.dataset.ayahNumber;
            if (surahNum && ayahNum) {
                showLoadingMessage(`Loading Ayah ${surahNum}:${ayahNum} from search result...`);
                surahSelect.value = surahNum;
                await populateAyahDropdownForSurah(surahNum); 
                ayahSelect.value = ayahNum;
                await displaySingleAyah(); 
            }
        }
    });

    // Event Listeners
    surahSelect.addEventListener("change", handleSurahChange);
    ayahSelect.addEventListener("change", () => { if(ayahSelect.value) displaySingleAyah(); });
    translationSelect.addEventListener("change", handleSettingsChange);
    reciterSelect.addEventListener("change", handleSettingsChange);
    showAyahButton.addEventListener("click", displaySingleAyah);
    showFullSurahButton.addEventListener("click", displayFullSurah);
    searchKeywordButton.addEventListener("click", searchByKeyword);

    // Initial Load
    initializeQuranExplorer();</script></p></div></article></main><footer class="footer"><div class="footer__inner"><div class="footer__copyright"><p><span style="color: #2dc26b;">© 2025 All rights reserved. This website and its content are the property of the owner</span></p></div></div></footer></div><script defer="defer" src="https://www.shoib.me/assets/js/scripts.min.js?v=c2232aa7558e9517946129d2a1b8c770"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'overlay',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script>(function() {
			var originalTitle = document.title;
			var timeout;
			document.addEventListener("visibilitychange", function() {
				if (document.hidden) {
					document.title = "👀 We miss you! Plz Come back!";
				} else {
					clearTimeout(timeout);
					document.title = "🎉 Welcome back!";
							setTimeout(function() {
								document.title = originalTitle;
							}, 2000);
				}
			});
		})();</script></body></html>